// Broker GPT — Policy Baseline (commented)
// Source of truth for engine defaults. Comments are allowed and stripped at runtime.
// Do not change key names without updating schema, README, and tests.
// Units: unless noted otherwise, prices are in THOUSANDS VND/share; fractions are 0..1.
{
  // Fraction of NAV allocated to BUY orders today (guardrailed 0.02..0.30; default 0.10)
  "buy_budget_frac": 0.10,
  // Optional mapping for regime-aware budgets (risk_on/neutral/risk_off). Values clipped 0..0.30.
  "buy_budget_by_regime": {
    "risk_on": 0.12,
    "neutral": 0.06,
    "risk_off": 0.0
  },
  // Max number of add-on BUY orders (adds to existing positions) that can be opened today (guardrailed 0..10)
  "add_max": 6,
  // Max number of new positions that can be opened today (guardrailed 0..10)
  "new_max": 3,

  // Weights for conviction score components used to rank candidates
  // Positive weights increase attractiveness; negative weights penalize.
  // fund_scale globally scales fundamental weights to match horizon.
  "weights": {
    // Trend/breadth within a ticker: 0.6*AboveMA50 + 0.4*AboveMA20
    "w_trend": 0.35,
    // Momentum composite: 0.6*RSI60_score + 0.4*MACD-Hist positive
    "w_momo": 0.25,
    // Return-based momentum (e.g., 63d) transformed to [0..1]
    "w_mom_ret": 0.15,
    // Liquidity favor (ADTV/percentile), higher is better
    "w_liq": 0.2,
    // Volatility guard (lower vol → higher component); usually negative to penalize high vol
    "w_vol_guard": -0.1,
    // Beta penalty vs VNINDEX (higher beta → higher penalty when weight < 0)
    "w_beta": -0.1,
    // Sector strength boost from computed sector ranks (breadth/leadership)
    "w_sector": 0.2,
    // Sector sentiment tilt from sector_bias map (policy overrides/AI)
    "w_sector_sent": 0.1,
    // Per-ticker sentiment tilt from ticker_bias map
    "w_ticker_sent": 0.1,
    // Fundamentals: Return on Equity component
    "w_roe": 0.15,
    // Fundamentals: Earnings Yield component
    "w_earnings_yield": 0.15,
    // Relative Strength component (optional; set 0 if unused)
    "w_rs": 0.15,
    // Global scale for fundamental weights (align horizon), default 1.0
    "fund_scale": 1.0
  },
  // Action thresholds and exits. Many of these can be calibrated from data.
  "thresholds": {
    // Baseline conviction required to ADD to an existing position (0..1)
    "base_add": 0.35,
    // Baseline conviction required to OPEN a NEW position (0..1)
    "base_new": 0.4,
    // Trim threshold relative to entry/score; negative trims on weakness (-1..1)
    "trim_th": -0.05,
    // Quantile gates for add/new, computed vs current candidate distributions (0..1)
    "q_add": 0.7,
    "q_new": 0.8,
    // Minimum normalized liquidity required for eligibility (0..1)
    "min_liq_norm": 0.3,
    // Consider a price "near ceiling" when Price/BandCeiling ≥ this fraction; avoid chasing
    "near_ceiling_pct": 0.98,
    // Static TP/SL kept for rollback; set to 0 when using per-ticker ATR mode
    "tp_pct": 0.0,
    "sl_pct": 0.0,
    // Dynamic TP/SL multipliers relative to ATR% (computed as multiplier × ATR_pct in decimal)
    "tp_atr_mult": 1.35,
    "sl_atr_mult": 1.7,
    // Floors/caps for per-ticker ATR exits (fractions of price)
    "tp_floor_pct": 0.03,
    "tp_cap_pct": 0.10,
    "sl_floor_pct": 0.02,
    "sl_cap_pct": 0.08,
    // Fraction to trim at TP events (0..1)
    "tp_trim_frac": 0.4,
    // Combination rules kept for rollback; default dynamic per ticker
    "tp_rule": "dynamic_only",
    "sl_rule": "dynamic_only",
    // Activate ATR-per-ticker exit mode (legacy|atr_per_ticker)
    "tp_sl_mode": "atr_per_ticker",
    // Stateless TP1/trailing configuration
    "tp1_frac": 0.40,
    "tp1_hh_lookback": 10,
    "trail_hh_lookback": 22,
    "trail_atr_mult": 2.5,
    "be_buffer_pct": 0.0,
    // Stop-loss trim ladder (fractions of SL distance and position size)
    "sl_trim_step_1_trigger": 0.5,
    "sl_trim_step_1_frac": 0.25,
    "sl_trim_step_2_trigger": 0.8,
    "sl_trim_step_2_frac": 0.35,
    // Multi-target ATR scaling for staged exits
    "tp1_atr_mult": 1.0,
    "tp2_atr_mult": 1.8,
    "trailing_atr_mult": 1.5,
    "trim_frac_tp1": 0.45,
    "trim_frac_tp2": 0.30,
    "breakeven_after_tp1": 1,
    "time_stop_days": 5,
    "trim_rsi_gate": 70.0,
    "cooldown_days_after_exit": 2,
    // Partial entry controls (stateless)
    // Baseline bật partial entry để phù hợp khẩu vị giải ngân dần
    "partial_entry_enabled": 1,
    "partial_entry_frac": 0.30,
    "partial_entry_floor_lot": 1,
    "new_partial_buffer": 0.05,
    // Exit on MA20/MA50 break heuristic (1/0 = on/off)
    "exit_on_ma_break": 1,
    // Cooldown days after exit before re‑entry signals are allowed
    "cooldown_days": 3,
    // RSI thresholds to gate/downgrade exits/trim under weak momentum (0..100)
    "exit_ma_break_rsi": 45.0,
    "trim_rsi_below_ma20": 45.0,
    "trim_rsi_macdh_neg": 40.0,
    // Allow MA‑break EXIT to downgrade to TRIM when conviction is strong (0..1)
    "exit_ma_break_score_gate": 0.35,
    // Minimum positive ticker_bias to allow EXIT→TRIM downgrade (0..1)
    "tilt_exit_downgrade_min": 0.05,
    // Minimum R multiple required to allow EXIT→TRIM downgrade (>=0). 0 = disabled.
    "exit_downgrade_min_r": 1.0,
    // Increase base_add/base_new by tc_gate_scale × pricing.tc_roundtrip_frac
    "tc_gate_scale": 0.0,
    // Earliest session phase to allow MA‑break exits: morning|lunch|afternoon|atc|post
    "exit_ma_break_min_phase": "afternoon",
    // Quantile pool used for q_add/q_new: subset (eligible) or full universe
    "quantile_pool": "subset"
  },
  // Neutral/sideways adaptive entry parameters (stateless)
  "neutral_adaptive": {
    // Enable neutral detection and adaptive behavior (0/1)
    "neutral_enable": 1,
    // Risk-on probability band (inclusive) considered neutral
    "neutral_risk_on_prob_low": 0.35,
    "neutral_risk_on_prob_high": 0.65,
    // Use index ATR percentile soft cap (fallback to market_filter.index_atr_soft_pct when null)
    "neutral_index_atr_soft_cap": null,
    // Breadth tolerance ± around neutral centre (~50%)
    "neutral_breadth_band": 0.05,
    "neutral_breadth_center": null,
    // Threshold scaling (floors applied on original thresholds)
    "neutral_base_new_scale": 0.90,
    "neutral_base_new_floor": 0.80,
    "neutral_base_add_scale": 0.90,
    "neutral_base_add_floor": 0.80,
    // Partial entry triggers when score ≥ ratio × base_new
    "partial_threshold_ratio": 0.75,
    "partial_entry_frac": 0.30,
    "partial_allow_leftover": 0,
    // Daily overrides to ensure minimum fresh entries when neutral
    "min_new_per_day": 1,
    "max_new_overrides_per_day": 1,
    // Cap number of ADD orders kept when neutral
    "add_max_neutral_cap": 1
  },
  // Logistic regime model mapping normalized components to risk‑on probability
  "regime_model": {
    // Logistic intercept and decision threshold (0..1)
    "intercept": -0.15,
    "threshold": 0.55,
    "components": {
      // Each component provides mean/std (for z‑scoring) and its logistic weight
      "trend": {
        "mean": 0.48,
        "std": 0.18,
        "weight": 1.55
      },
      "momentum": {
        "mean": 0.52,
        "std": 0.22,
        "weight": 1.25
      },
      "breadth": {
        "mean": 0.45,
        "std": 0.2,
        "weight": 1.2
      },
      "drawdown": {
        "mean": 0.62,
        "std": 0.24,
        "weight": 0.95
      },
      "volatility": {
        "mean": 0.56,
        "std": 0.21,
        "weight": 1.05
      },
      "index_return": {
        "mean": 0.0,
        "std": 0.65,
        "weight": 0.8
      },
      "turnover": {
        "mean": 0.5,
        "std": 0.2,
        "weight": 0.8
      },
      "mcclellan": {
        "mean": 0.5,
        "std": 0.25,
        "weight": 0.6
      },
      "nhnl": {
        "mean": 0.5,
        "std": 0.25,
        "weight": 0.6
      }
    }
  },

  // Sector‑level tilts in [-0.20..+0.20]. Keys MUST match exactly the Sector labels
  // in data/industry_map.csv (Vietnamese). Allowed labels at time of writing:
  //   Bất động sản, Công nghiệp, Công nghệ thông tin, Dịch vụ tiện ích,
  //   Hàng tiêu dùng không thiết yếu, Hàng tiêu dùng thiết yếu,
  //   Nguyên vật liệu, Năng lượng, Tài chính, Y tế
  // Values should stay within [-0.20..+0.20]; any decay/expiry must be handled by the tuner or review process.
  "sector_bias": {},

  // Per‑ticker tilts in [-0.20..+0.20]. Keys are uppercase tickers (e.g., HPG, MWG).
  // Values should stay within [-0.20..+0.20]; any decay/expiry must be handled by the tuner or review process.
  "ticker_bias": {},

  // Optional: one‑shot calibrations executed on run when enabled (no env toggles)
  "calibration": {
    "on_run": 0,
    "regime_components": 0,
    "regime": 0,
    "market_filter": 0,
    "breadth_floor": 0,
    "leader_gates": 0,
    "liquidity": 0,
    "sizing": 0,
    "softmax_tau": 0,
    "thresholds_topk": 0,
    "risk_limits": 0,
    "dynamic_caps": 0
  },
  // Market regime guards; most values can be calibrated from history percentiles
  "market_filter": {
    // Risk‑off when single‑day index drop ≤ this (negative) threshold (absolute magnitude as fraction)
    "risk_off_index_drop_pct": 0.03,
    // Risk‑off when trend component below this (0..1)
    "risk_off_trend_floor": 0.0,
    // Risk‑off when breadth (pct > MA50) below this (0..1)
    "risk_off_breadth_floor": 0.4,
    // Risk‑off when index drawdown percentile ≥ this floor (0..1)
    "risk_off_drawdown_floor": 0.03765736205513479,
    // Soft/hard floors on risk‑on probability from regime model (0..1)
    "market_score_soft_floor": 0.60,
    "market_score_hard_floor": 0.30,
    // “Leader” ticker gate: minimum RSI and momentum to qualify as leaders
    "leader_min_rsi": 55.0,
    "leader_min_mom_norm": 0.6,
    "leader_require_ma20": 1,
    "leader_require_ma50": 1,
    "leader_max": 2,
    // Index ATR percentile soft/hard caps; scale budget when soft, freeze when hard
    "index_atr_soft_pct": 0.80041928721174,
    "index_atr_hard_pct": 0.950104821802935,
    // Caps applied under guards (fractions of planned budget)
    "guard_new_scale_cap": 0.4,
    "atr_soft_scale_cap": 0.5,
    // Multiplier applied to risk_off_index_drop_pct for severe scenario
    "severe_drop_mult": 1.5,
    // Additional hard guards (optional, can be null to disable)
    "idx_chg_smoothed_hard_drop": 0.025,
    "trend_norm_hard_floor": -0.36045671543390645,
    "vol_ann_hard_ceiling": 0.40,
    "us_epu_soft_pct": null,
    "us_epu_hard_pct": null,
    "dxy_soft_pct": null,
    "dxy_hard_pct": null,
    "spx_drawdown_hard_pct": null
  },
  // Pricing presets and execution heuristics
  "pricing": {
    // Execution priority presets by regime: from most aggressive to most conservative
    "risk_on_buy": [
      "Aggr",
      "Bal",
      "Cons",
      "MR",
      "Break"
    ],
    "risk_on_sell": [
      "Cons",
      "Bal",
      "Break",
      "MR",
      "Aggr"
    ],
    "risk_off_buy": [
      "Cons",
      "MR",
      "Bal",
      "Aggr",
      "Break"
    ],
    "risk_off_sell": [
      "MR",
      "Cons",
      "Bal",
      "Aggr",
      "Break"
    ],
    // Fallback distance when ATR is unavailable: multiplier × tick size
    "atr_fallback_buy_mult": 0.25,
    "atr_fallback_sell_mult": 0.25,
    // Transaction cost assumptions
    "tc_sell_tax_frac": 0.001,
    "tc_roundtrip_frac": 0.0,
    // Fill probability heuristics for orders_quality.csv (UI/diagnostic only)
    "fill_prob": {
      "base": 0.3,
      "cross": 0.9,
      "near_ceiling": 0.05,
      "min": 0.05,
      "decay_scale_min_ticks": 5.0,
      "partial_fill_kappa": 0.65,
      "min_fill_notional_vnd": 5000000.0
    },
    "slippage_model": {
      "alpha_bps": 5.0,
      "beta_dist_per_tick": 1.0,
      "beta_size": 45.0,
      "beta_vol": 8.0,
      "mae_bps": 15.0,
      "last_fit_date": null
    }
  },
  "execution": {
    // Minimum time-to-live (minutes) a stop order stays active before we consider it stale
    "stop_ttl_min": 3,
    // Floor on slippage applied when sizing exits, expressed as fraction of price
    "slip_pct_min": 0.002,
    // Additional slippage buffer scaled by ATR% when volatility elevated
    "slip_atr_mult": 0.5,
    // Minimum number of ticks assumed for slippage regardless of ATR or pct floors
    "slip_ticks_min": 1,
    // Multiplier on ATR used to detect/guard against flash-move volatility spikes
    "flash_k_atr": 1.5
  },
  // Normalization scales for regime diagnostics (avoid hidden constants)
  "regime_scales": {
    "vol_ann_unit": 0.45,
    "trend_unit": 0.05,
    "idx_smoothed_unit": 1.5,
    "drawdown_unit": 0.2,
    "momentum_unit": 0.12
  },
  // Portfolio sizing and allocation model
  "sizing": {
    // Softmax temperature for score→weight mapping (higher = flatter)
    "softmax_tau": 0.6,
    // Share of daily budget for adds/new candidates (0..1), relative to buy_budget_frac
    "add_share": 0.5,
    "new_share": 0.5,
    // Minimum lot size (shares) on HOSE is 100
    "min_lot": 100,
    // Risk weighting scheme: score_softmax | inverse_atr | hybrid | risk_parity | inverse_sigma
    "risk_weighting": "risk_parity",
    // Risk aversion for risk-parity/mean-variance (non-negative)
    "risk_alpha": 5.0,
    // Static caps (fractions of NAV)
    "max_pos_frac": 0.10,
    "max_sector_frac": 0.25,
    // Fraction of SELL proceeds that may be reused immediately for BUY in same session
    "reuse_sell_proceeds_frac": 0.0,
    // Blend for combining multiple risk models (0..1)
    "risk_blend": 1.0,
    // Redistribute leftover budget if some orders are filtered out (1=on)
    "leftover_redistribute": 1,
    // Minimum ticket notional in thousands VND (0 disables)
    "min_ticket_k": 0.0,
    "qty_min_lot": 100,
    "min_notional_per_order": 2000000.0,
    // Covariance estimation window and regularization
    "cov_lookback_days": 250,
    "cov_reg": 0.0003,
    // Floors for risk parity weights before normalization
    "risk_parity_floor": 0.2,
    // Optional dynamic caps scaled from ENP target; enable to override static caps
    "dynamic_caps": {
      "enable": 0,
      "pos_min": 0.1,
      "pos_max": 0.16,
      "sector_min": 0.28,
      "sector_max": 0.4,
      "blend": 1.0,
      "override_static": 0
    },
    // Allocation model: softmax | risk_budget | mean_variance
    "allocation_model": "mean_variance",
    // Black–Litterman parameters (annualized) for mean-variance
    "bl_rf_annual": 0.05,
    "bl_mkt_prem_annual": 0.08,
    "bl_alpha_scale": 0.025,
    "risk_blend_eta": 0.3,
    // Minimum number of names to target when allocating
    "min_names_target": 10,
    // Market index symbol used for beta/vol; must exist in out/prices_history.csv
    "market_index_symbol": "VNINDEX",
    // Risk-per-trade sizing (0 disables) and default ATR multiple for stops when enabled
    "risk_per_trade_frac": 0.005,
    "default_stop_atr_mult": 2.15,
    "tranche_frac": 0.25,
    // Max lots for the first non-partial NEW entry (caps initial size);
    // leftover redistribution or subsequent adds may increase later.
    "new_first_tranche_lots": 1,
    // Grid for calibrating mean-variance hyper-parameters (if enabled)
    "mean_variance_calibration": {
      "enable": 1,
      "risk_alpha": [4.0, 5.0, 6.0],
      "cov_reg": [0.0002, 0.0003, 0.0004],
      "bl_alpha_scale": [0.02, 0.025, 0.03],
      "lookback_days": 250,
      "test_horizon_days": 60,
      "min_history_days": 320
    }
  },
  // UX defaults for generated order files (non-trading policy)
  "orders_ui": {
    "ttl_minutes": {
      // Base/soft/hard time-to-live for orders, adjusted by volatility elsewhere
      // Guard: base ≥ soft ≥ hard and all within 5..15 minutes per desk guidance.
      // Values below were validated against 2023 Q4 fill/timeout stats (p75 ≈ 11 min),
      // leaving ~40% buffer before hard expiry so partial fills can complete safely.
      "base": 12,
      "soft": 9,
      "hard": 7
    },
    "ttl_bucket_minutes": {
      // Volatility buckets override the global TTLs. Lower vol = more patience.
      // Each bucket keeps a ≥2 minute spread from base→hard, matching desk SOP.
      "low": { "base": 14, "soft": 11, "hard": 8 },
      "medium": { "base": 11, "soft": 9, "hard": 7 },
      "high": { "base": 8, "soft": 6, "hard": 5 }
    },
    "watchlist": {
      // Move low-priority BUYs to watchlist when micro-tape weak
      "enable": 1,
      "min_priority": 0.30,
      "micro_window": 3
    },
    // Number of tickers shown in suggestions (UI only)
    "suggestions_top_n": 3
  },
  // Market microstructure defaults (for price band/tick logic)
  "market": {
    "microstructure": {
      "daily_band_pct": 0.07
    }
  },
  // Controls for portfolio evaluation report (non-trading)
  "evaluation": {
    "days_to_liq_frac": 0.2
  },
  // Feature-engineering flags (normalization modes)
  "features": {
    "normalization_robust": 0
  },
  // Guidance targets for formula-based calibrators
  "calibration_targets": {
    "thresholds": {
      // Near-ceiling quantile for Price/BandCeiling. Higher = stricter near-ceiling gate
      // Use high percentile to avoid over-filtering during strong tapes.
      "near_ceiling_q": 0.99
    },
    "market_filter": {
      "idx_drop_q": 0.1,
      "vol_ann_q": 0.95,
      "trend_floor_q": 0.1,
      // Calibrate ATR guard on high percentiles to avoid premature budget cuts
      "atr_soft_q": 0.90,
      "atr_hard_q": 0.97,
      "ms_soft_q": 0.6,
      "ms_hard_q": 0.35,
      "dd_floor_q": 0.8,
      "breadth_floor_q": 0.4,
      // Exponential half-life (days) for weighting breadth history toward recent data
      "breadth_floor_half_life_days": 126,
      // Hard clamps to avoid unrealistic guard thresholds in thin breadth regimes
      "breadth_floor_min": 0.32,
      "breadth_floor_max": 0.48,
      "leader_rsi_q": 0.75,
      "leader_mom_q": 0.75
    },
    "liquidity": {
      // Notional guard: per‑order notional ≤ α × ADTV20 (α below)
      "adtv_multiple": 20.0
    },
    "sizing": {
      "enp_target_add": 4.0,
      "enp_target_new": 3.0
    },
    "dynamic_caps": {
      "enp_total_target": 9,
      "sector_limit_target": 0.35
    }
  }
}
